[
  {
    "id": "TA-LT-4-1",
    "description": "Diagnostic logs in App Services should be enabled",
    "recommendation": "Enable diagnostic Logs in App Services",
    "helpUri": "https://github.com/Azure/template-analyzer/blob/main/docs/built-in-bpa-rules.md/#diagnostic-logs-in-app-services-should-be-enabled",
    "evaluation": {
      "resourceType": "Microsoft.Web/sites",
      "where": {
        "allOf": [
          {
            "path": "kind",
            "regex": "^((?!functionapp).)*$"
          },
          {
            "path": "kind",
            "regex": "^((?!linux).)*$"
          }
        ]
      },
      "anyOf": [
        {
          "resourceType": "Microsoft.Web/sites/config",
          "allOf": [
            {
              "path": "properties.detailedErrorLoggingEnabled",
              "equals": true
            },
            {
              "path": "properties.httpLoggingEnabled",
              "equals": true
            },
            {
              "path": "properties.requestTracingEnabled",
              "equals": true
            }
          ]
        },
        {
          "allOf": [
            {
              "path": "properties.siteConfig.detailedErrorLoggingEnabled",
              "equals": true
            },
            {
              "path": "properties.siteConfig.httpLoggingEnabled",
              "equals": true
            },
            {
              "path": "properties.siteConfig.requestTracingEnabled",
              "equals": true
            }
          ]
        }
      ]
    }
  },
  {
    "id": "TA-PV-2-1",
    "description": "Remote debugging should be turned off for API Apps",
    "recommendation": "Remote debugging should be turned off",
    "helpUri": "https://github.com/Azure/template-analyzer/blob/main/docs/built-in-bpa-rules.md/#remote-debugging-should-be-turned-off-for-api-apps",
    "evaluation": {
      "resourceType": "Microsoft.Web/sites",
      "where": {
        "path": "kind",
        "regex": "api$"
      },
      "allOf": [
        {
          "resourceType": "Microsoft.Web/sites/config",
          "where": {
            "path": "name",
            "regex": "web$"
          },
          "allOf": [
            {
              "path": "properties.remoteDebuggingEnabled",
              "notEquals": true
            }
          ]
        },
        {
          "path": "properties.siteConfig.remoteDebuggingEnabled",
          "notEquals": true
        }
      ]
    }
  },
  {
    "id": "TA-DP-4-1",
    "description": "FTPS only should be required in your API App",
    "recommendation": "Enable FTPS enforcement for enhanced security",
    "helpUri": "https://github.com/Azure/template-analyzer/blob/main/docs/built-in-bpa-rules.md/#ftps-only-should-be-required-in-your-api-app",
    "evaluation": {
      "resourceType": "Microsoft.Web/sites",
      "where": {
        "path": "kind",
        "regex": "api$"
      },
      "anyOf": [
        {
          "resourceType": "Microsoft.Web/sites/config",
          "path": "properties.ftpsState",
          "in": [ "FtpsOnly", "Disabled" ]
        },
        {
          "path": "properties.siteConfig.ftpsState",
          "in": [ "FtpsOnly", "Disabled" ]
        }
      ]
    }
  },
  {
    "id": "TA-DP-4-2",
    "description": "API App should only be accessible over HTTPS",
    "recommendation": "Use HTTPS to ensure server/service authentication and protect data in transit from network layer eavesdropping attacks",
    "helpUri": "https://github.com/Azure/template-analyzer/blob/main/docs/built-in-bpa-rules.md#api-app-should-only-be-accessible-over-https",
    "evaluation": {
      "resourceType": "Microsoft.Web/sites",
      "where": {
        "path": "kind",
        "regex": "api$"
      },
      "allOf": [
        {
          "path": "properties.httpsOnly",
          "equals": true
        }
      ]
    }
  },
  {
    "id": "TA-DP-4-3",
    "description": "Latest TLS version should be used in your API App",
    "recommendation": "Upgrade to the latest TLS version",
    "helpUri": "https://github.com/Azure/template-analyzer/blob/main/docs/built-in-bpa-rules.md/#latest-tls-version-should-be-used-in-your-api-app",
    "evaluation": {
      "resourceType": "Microsoft.Web/sites",
      "where": {
        "path": "kind",
        "regex": "api$"
      },
      "anyOf": [
        {
          "resourceType": "Microsoft.Web/sites/config",
          "path": "properties.minTlsVersion",
          "equals": "1.2"
        },
        {
          "path": "properties.siteConfig.minTlsVersion",
          "equals": "1.2"
        }
      ]
    }
  },
  {
    "id": "TA-PV-2-2",
    "description": "CORS should not allow every resource to access your API App",
    "recommendation": "Cross-Origin Resource Sharing (CORS) should not allow all domains to access your API app. Allow only required domains to interact with your API app.",
    "helpUri": "https://github.com/Azure/template-analyzer/blob/main/docs/built-in-bpa-rules.md/#cors-should-not-allow-every-resource-to-access-your-api-app",
    "evaluation": {
      "resourceType": "Microsoft.Web/sites",
      "where": {
        "path": "kind",
        "regex": "api$"
      },
      "allOf": [
        {
          "resourceType": "Microsoft.Web/sites/config",
          "where": {
            "path": "name",
            "regex": "web$"
          },
          "allOf": [
            {
              "path": "properties.cors.allowedOrigins[*]",
              "notEquals": "*"
            }
          ]
        },
        {
          "path": "properties.siteConfig.cors.allowedOrigins[*]",
          "notEquals": "*"
        }
      ]
    }
  },
  {
    "id": "TA-IM-1-1-IM-2-1",
    "description": "Managed identity should be used in your API App",
    "recommendation": "Use a managed identity for enhanced authentication security",
    "helpUri": "https://github.com/Azure/template-analyzer/blob/main/docs/built-in-bpa-rules.md/#managed-identity-should-be-used-in-your-api-app",
    "evaluation": {
      "resourceType": "Microsoft.Web/sites",
      "where": {
        "path": "kind",
        "regex": "api$"
      },
      "allOf": [
        {
          "path": "identity.type",
          "in": [
            "UserAssigned",
            "SystemAssigned"
          ]
        }
      ]
    }
  },
  {
    "id": "TA-PV-2-3",
    "description": "Remote debugging should be turned off for Function Apps",
    "recommendation": "Remote debugging should be turned off",
    "helpUri": "https://github.com/Azure/template-analyzer/blob/main/docs/built-in-bpa-rules.md/#remote-debugging-should-be-turned-off-for-function-apps",
    "evaluation": {
      "resourceType": "Microsoft.Web/sites",
      "where": {
        "path": "kind",
        "regex": "^functionapp"
      },
      "allOf": [
        {
          "resourceType": "Microsoft.Web/sites/config",
          "where": {
            "path": "name",
            "regex": "web$"
          },
          "allOf": [
            {
              "path": "properties.remoteDebuggingEnabled",
              "notEquals": true
            }
          ]
        },
        {
          "path": "properties.siteConfig.remoteDebuggingEnabled",
          "notEquals": true
        }
      ]
    }
  },
  {
    "id": "TA-DP-4-4",
    "description": "FTPS only should be required in your Function App",
    "recommendation": "Enable FTPS enforcement for enhanced security",
    "helpUri": "https://github.com/Azure/template-analyzer/blob/main/docs/built-in-bpa-rules.md/#ftps-only-should-be-required-in-your-function-app",
    "evaluation": {
      "resourceType": "Microsoft.Web/sites",
      "where": {
        "path": "kind",
        "regex": "^functionapp"
      },
      "anyOf": [
        {
          "resourceType": "Microsoft.Web/sites/config",
          "path": "properties.ftpsState",
          "in": [ "FtpsOnly", "Disabled" ]
        },
        {
          "path": "properties.siteConfig.ftpsState",
          "in": [ "FtpsOnly", "Disabled" ]
        }
      ]
    }
  },
  {
    "id": "TA-DP-4-5",
    "description": "Function App should only be accessible over HTTPS",
    "recommendation": "Use HTTPS to ensure server/service authentication and protect data in transit from network layer eavesdropping attacks",
    "helpUri": "https://github.com/Azure/template-analyzer/blob/main/docs/built-in-bpa-rules.md/#function-app-should-only-be-accessible-over-https",
    "evaluation": {
      "resourceType": "Microsoft.Web/sites",
      "where": {
        "path": "kind",
        "regex": "^functionapp"
      },
      "allOf": [
        {
          "path": "properties.httpsOnly",
          "equals": true
        }
      ]
    }
  },
  {
    "id": "TA-DP-4-6",
    "description": "Latest TLS version should be used in your Function App",
    "recommendation": "Upgrade to the latest TLS version",
    "helpUri": "https://github.com/Azure/template-analyzer/blob/main/docs/built-in-bpa-rules.md/#latest-tls-version-should-be-used-in-your-function-app",
    "evaluation": {
      "resourceType": "Microsoft.Web/sites",
      "where": {
        "path": "kind",
        "regex": "^functionapp"
      },
      "anyOf": [
        {
          "resourceType": "Microsoft.Web/sites/config",
          "path": "properties.minTlsVersion",
          "equals": "1.2"
        },
        {
          "path": "properties.siteConfig.minTlsVersion",
          "equals": "1.2"
        }
      ]
    }
  },
  {
    "id": "TA-PV-2-4",
    "description": "CORS should not allow every resource to access your Function Apps",
    "recommendation": "Cross-Origin Resource Sharing (CORS) should not allow all domains to access your Function app. Allow only required domains to interact with your Function app.",
    "helpUri": "https://github.com/Azure/template-analyzer/blob/main/docs/built-in-bpa-rules.md/#cors-should-not-allow-every-resource-to-access-your-function-apps",
    "evaluation": {
      "resourceType": "Microsoft.Web/sites",
      "where": {
        "path": "kind",
        "regex": "^functionapp"
      },
      "allOf": [
        {
          "resourceType": "Microsoft.Web/sites/config",
          "where": {
            "path": "name",
            "regex": "web$"
          },
          "allOf": [
            {
              "path": "properties.cors.allowedOrigins[*]",
              "notEquals": "*"
            }
          ]
        },
        {
          "path": "properties.siteConfig.cors.allowedOrigins[*]",
          "notEquals": "*"
        }
      ]
    }
  },
  {
    "id": "TA-IM-1-2-IM-2-2",
    "description": "Managed identity should be used in your Function App",
    "recommendation": "Use a managed identity for enhanced authentication security",
    "helpUri": "https://github.com/Azure/template-analyzer/blob/main/docs/built-in-bpa-rules.md/#managed-identity-should-be-used-in-your-function-app",
    "evaluation": {
      "resourceType": "Microsoft.Web/sites",
      "where": {
        "path": "kind",
        "regex": "^functionapp"
      },
      "allOf": [
        {
          "path": "identity.type",
          "in": [
            "UserAssigned",
            "SystemAssigned"
          ]
        }
      ]
    }
  },
  {
    "id": "TA-PV-2-5",
    "description": "Remote debugging should be turned off for Web Applications",
    "recommendation": "Remote debugging should be turned off",
    "helpUri": "https://github.com/Azure/template-analyzer/blob/main/docs/built-in-bpa-rules.md/#remote-debugging-should-be-turned-off-for-web-applications",
    "evaluation": {
      "resourceType": "Microsoft.Web/sites",
      "where": {
        "anyOf": [
          {
            "path": "kind",
            "exists": false
          },
          {
            "path": "kind",
            "regex": "^app"
          }
        ]
      },
      "allOf": [
        {
          "resourceType": "Microsoft.Web/sites/config",
          "where": {
            "path": "name",
            "regex": "web$"
          },
          "allOf": [
            {
              "path": "properties.remoteDebuggingEnabled",
              "notEquals": true
            }
          ]
        },
        {
          "path": "properties.siteConfig.remoteDebuggingEnabled",
          "notEquals": true
        }
      ]
    }
  },
  {
    "id": "TA-DP-4-7",
    "description": "FTPS only should be required in your Web App",
    "recommendation": "Enable FTPS enforcement for enhanced security",
    "helpUri": "https://github.com/Azure/template-analyzer/blob/main/docs/built-in-bpa-rules.md/#ftps-only-should-be-required-in-your-web-app",
    "evaluation": {
      "resourceType": "Microsoft.Web/sites",
      "where": {
        "anyOf": [
          {
            "path": "kind",
            "exists": false
          },
          {
            "path": "kind",
            "regex": "^app"
          }
        ]
      },
      "anyOf": [
        {
          "resourceType": "Microsoft.Web/sites/config",
          "path": "properties.ftpsState",
          "in": [ "FtpsOnly", "Disabled" ]
        },
        {
          "path": "properties.siteConfig.ftpsState",
          "in": [ "FtpsOnly", "Disabled" ]
        }
      ]
    }
  },
  {
    "id": "TA-DP-4-8",
    "description": "Web Application should only be accessible over HTTPS",
    "recommendation": "Use HTTPS to ensure server/service authentication and protect data in transit from network layer eavesdropping attacks",
    "helpUri": "https://github.com/Azure/template-analyzer/blob/main/docs/built-in-bpa-rules.md/#web-application-should-only-be-accessible-over-https",
    "evaluation": {
      "resourceType": "Microsoft.Web/sites",
      "where": {
        "anyOf": [
          {
            "path": "kind",
            "exists": false
          },
          {
            "path": "kind",
            "regex": "^app"
          }
        ]
      },
      "allOf": [
        {
          "path": "properties.httpsOnly",
          "equals": true
        }
      ]
    }
  },
  {
    "id": "TA-DP-4-9",
    "description": "Latest TLS version should be used in your Web App",
    "recommendation": "Upgrade to the latest TLS version",
    "helpUri": "https://github.com/Azure/template-analyzer/blob/main/docs/built-in-bpa-rules.md/#latest-tls-version-should-be-used-in-your-web-app",
    "evaluation": {
      "resourceType": "Microsoft.Web/sites",
      "where": {
        "anyOf": [
          {
            "path": "kind",
            "exists": false
          },
          {
            "path": "kind",
            "regex": "^app"
          }
        ]
      },
      "anyOf": [
        {
          "resourceType": "Microsoft.Web/sites/config",
          "path": "properties.minTlsVersion",
          "equals": "1.2"
        },
        {
          "path": "properties.siteConfig.minTlsVersion",
          "equals": "1.2"
        }
      ]
    }
  },
  {
    "id": "TA-PV-2-6",
    "description": "CORS should not allow every resource to access your Web Applications",
    "recommendation": "Cross-Origin Resource Sharing (CORS) should not allow all domains to access your Web application. Allow only required domains to interact with your Web app.",
    "helpUri": "https://github.com/Azure/template-analyzer/blob/main/docs/built-in-bpa-rules.md/#cors-should-not-allow-every-resource-to-access-your-web-applications",
    "evaluation": {
      "resourceType": "Microsoft.Web/sites",
      "where": {
        "anyOf": [
          {
            "path": "kind",
            "exists": false
          },
          {
            "path": "kind",
            "regex": "^app"
          }
        ]
      },
      "allOf": [
        {
          "resourceType": "Microsoft.Web/sites/config",
          "where": {
            "path": "name",
            "regex": "web$"
          },
          "allOf": [
            {
              "path": "properties.cors.allowedOrigins[*]",
              "notEquals": "*"
            }
          ]
        },
        {
          "path": "properties.siteConfig.cors.allowedOrigins[*]",
          "notEquals": "*"
        }
      ]
    }
  },
  {
    "id": "TA-IM-1-3-IM-2-3",
    "description": "Managed identity should be used in your Web App",
    "recommendation": "Use a managed identity for enhanced authentication security",
    "helpUri": "https://github.com/Azure/template-analyzer/blob/main/docs/built-in-bpa-rules.md/#managed-identity-should-be-used-in-your-web-app",
    "evaluation": {
      "resourceType": "Microsoft.Web/sites",
      "where": {
        "anyOf": [
          {
            "path": "kind",
            "exists": false
          },
          {
            "path": "kind",
            "regex": "^app"
          }
        ]
      },
      "allOf": [
        {
          "path": "identity.type",
          "in": [
            "UserAssigned",
            "SystemAssigned"
          ]
        }
      ]
    }
  },
  {
    "id": "TA-PA-7-1",
    "description": "Use built-in roles instead of custom RBAC roles",
    "recommendation": "Use built-in roles such as 'Owner, Contributer, Reader' instead of custom RBAC roles",
    "helpUri": "https://github.com/Azure/template-analyzer/blob/main/docs/built-in-bpa-rules.md/#use-built-in-roles-instead-of-custom-rbac-roles",
    "evaluation": {
      "resourceType": "Microsoft.Authorization/roleDefinitions",
      "path": "properties.type",
      "notEquals": "CustomRole"
    }
  },
  {
    "id": "TA-DP-5-1",
    "description": "Automation account variables should be encrypted",
    "recommendation": "Enable encryption of Automation account variable assets when storing sensitive data",
    "helpUri": "https://github.com/Azure/template-analyzer/blob/main/docs/built-in-bpa-rules.md/#automation-account-variables-should-be-encrypted",
    "evaluation": {
      "resourceType": "Microsoft.Automation/automationAccounts/variables",
      "path": "properties.isEncrypted",
      "equals": true
    }
  },
  {
    "id": "TA-DP-4-10",
    "description": "Only secure connections to your Azure Cache for Redis should be enabled",
    "recommendation": "Enable connections via SSL only to Redis Cache",
    "helpUri": "https://github.com/Azure/template-analyzer/blob/main/docs/built-in-bpa-rules.md/#onlysecureconnectionstoyourazurecacheforredisshouldbeenabled",
    "evaluation": {
      "resourceType": "Microsoft.Cache/redis",
      "path": "properties.enableNonSslPort",
      "notEquals": true
    }
  },
  {
    "id": "TA-NS-1-1-NS-4-1",
    "description": "Authorized IP ranges should be defined on Kubernetes Services",
    "recommendation": "Restrict access to the Kubernetes Service Management API by granting API access only to IP addresses in specific ranges",
    "helpUri": "https://github.com/Azure/template-analyzer/blob/main/docs/built-in-bpa-rules.md/#authorized-ip-ranges-should-be-defined-on-kubernetes-services",
    "evaluation": {
      "resourceType": "Microsoft.ContainerService/managedClusters",
      "anyOf": [
        {
          "path": "properties.apiServerAccessProfile.authorizedIPRanges",
          "exists": true
        },
        {
          "path": "properties.apiServerAccessProfile.enablePrivateCluster",
          "equals": true
        }
      ]
    }
  },
  {
    "id": "TA-PA-7-2",
    "description": "Role-Based Access Control (RBAC) should be used on Kubernetes Services",
    "recommendation": "Enable RBAC in Kubernetes clusters",
    "helpUri": "https://github.com/Azure/template-analyzer/blob/main/docs/built-in-bpa-rules.md/#role-basedaccesscontrolrbacshouldbeusedonkubernetesservices",
    "evaluation": {
      "resourceType": "Microsoft.ContainerService/managedClusters",
      "allOf": [
        {
          "path": "properties.enableRBAC",
          "hasValue": true
        },
        {
          "path": "properties.enableRBAC",
          "equals": true
        }
      ]
    }
  },
  {
    "id": "TA-PV-7-1",
    "description": "Kubernetes Services should be upgraded to a non-vulnerable Kubernetes version",
    "recommendation": "Upgrade to a non-vulnerable Kubernetes version (1.11.9+, 1.12.7+, 1.13.5+, and 1.14.0+)",
    "helpUri": "https://github.com/Azure/template-analyzer/blob/main/docs/built-in-bpa-rules.md/#kubernetes-services-should-be-upgraded-to-a-non-vulnerable-kubernetes-version",
    "evaluation": {
      "resourceType": "Microsoft.ContainerService/managedClusters",
      "allOf": [
        {
          "not": {
            "path": "properties.kubernetesVersion",
            "regex": "^1\\.((11\\.[0-8])|(12\\.[0-6])|(13\\.[0-4]))"
          }
        },
        {
          "not": {
            "path": "properties.kubernetesVersion",
            "regex": "^1\\.(([0-9]|10)\\.\\d+)"
          }
        }
      ]
    }
  },
  {
    "id": "TA-IM-1-4",
    "description": "Service Fabric clusters should only use Azure Active Directory for client authentication",
    "recommendation": "Enable AAD client authentication on your Service Fabric clusters",
    "helpUri": "https://github.com/Azure/template-analyzer/blob/main/docs/built-in-bpa-rules.md/#service-fabric-clusters-should-only-use-azure-active-directory-for-client-authentication",
    "evaluation": {
      "resourceType": "Microsoft.ServiceFabric/clusters",
      "path": "properties.azureActiveDirectory.tenantId",
      "hasValue": true
    }
  },
  {
    "id": "TA-DP-2-1-DP-5-2",
    "description": "Transparent Data Encryption on SQL databases should be enabled",
    "recommendation": "Transparent data encryption should be enabled to protect data-at-rest and meet compliance requirements",
    "helpUri": "https://github.com/Azure/template-analyzer/blob/main/docs/built-in-bpa-rules.md/#transparent-data-encryption-on-sql-databases-should-be-enabled",
    "evaluation": {
      "resourceType": "Microsoft.Sql/servers/databases",
      "where": {
        "path": "name",
        "regex": ".+(?<!master)$"
      },
      "allOf": [
        {
          "resourceType": "Microsoft.Sql/servers/databases/transparentDataEncryption",
          "path": "properties.state",
          "equals": "enabled"
        }
      ]
    }
  },
  {
    "id": "TA-LT-6-1",
    "description": "SQL servers with auditing to storage account destination should be configured with 90 days retention or higher",
    "recommendation": "Set the data retention for your SQL Server's auditing to storage account destination to at least 90 days",
    "helpUri": "https://github.com/Azure/template-analyzer/blob/main/docs/built-in-bpa-rules.md/#sql-servers-with-auditing-to-storage-account-destination-should-be-configured-with-90-days-retention-or-higher",
    "evaluation": {
      "resourceType": "Microsoft.Sql/servers",
      "where": {
        "path": "properties.kind",
        "regex": "^((?!analytics).)*$"
      },
      "allOf": [
        {
          "resourceType": "Microsoft.Sql/servers/auditingSettings",
          "where": {
            "path": "name",
            "equals": "default"
          },
          "anyOf": [
            {
              "allOf": [
                {
                  "path": "properties.isAzureMonitorTargetEnabled",
                  "equals": true
                },
                {
                  "path": "properties.storageEndpoint",
                  "hasValue": false
                }
              ]
            },
            {
              "path": "properties.retentionDays",
              "equals": 0 // 0 == unlimited retention
            },
            {
              "path": "properties.retentionDays",
              "greaterOrEquals": 90
            }
          ]
        }
      ]
    }
  }
]